trigger:
  branches:
    include:
      - feature/*
      - dev
# startput voor je pipeline. The trigger section specifies that the pipeline will be triggered by changes to branch dev or any branch that starts with feature/ .

# pr:
#   - dev


pool:
  vmImage: 'ubuntu-latest'

steps:

- task: NodeTool@0
  inputs:
    versionSpec: '22.0.0'

- task: UseRubyVersion@0
  inputs:
    versionSpec: '>= 2.4'

- script: |
    echo "Installing packages"
    sudo npm install -g aws-cdk
    sudo gem install cfn-nag    
  displayName: 'Installing aws cdk and cfn nag'

# - script: |
#     echo "Installing project dependencies"
#     sudo npm install
#     sudo npm run build    
#   displayName: 'Installing project dependencies'


# Testing construct with pytest
- script: |
    echo "Testing construct with pytest"
    pip install -r requirements.txt # to prevent ModuleNotFoundError: No module named 'aws_cdk'
    pip install -U pytest
    python -m pytest
  displayName: 'Testing construct with pytest'

- task: AWSShellScript@1
  inputs:
    awsCredentials: 'AWS-SANDBOX'
    regionName: 'eu-central-1'
    scriptType: 'inline'
    inlineScript: |
      echo "Running validations"
      cdk synth -o out
      cd out
      fname=$(find *.template.json)
      echo "Testing output with cfn-nag-scan"
      cfn_nag_scan --input-path $fname
  displayName: 'Validating AWS CDK output'

- task: AWSShellScript@1
  inputs:
    awsCredentials: 'AWS-SANDBOX'
    regionName: 'eu-central-1'
    scriptType: 'inline'
    inlineScript: |
      echo "Generating CDK diff file"
      cdk diff -o out -c aws-cdk:enableDiffNoFail=true --no-color "*" 2>&1 | sed -n '/Resources/,/Outputs/p' | sed 's/├/\+/g; s/│/|/g; s/─/-/g; s/└/`/g' | head -n -1 | tee output.log
      sed -i '1 i\```bash' output.log
      sed -i -e '$a```' output.log
  displayName: 'Generating CDK diff file'

# onderstaan werkt enkel met een PR of issue.
# GitHub Comment v0   https://learn.microsoft.com/en-us/azure/devops/pipelines/tasks/reference/github-comment-v0?view=azure-pipelines
# via https://dev.azure.com/1robroos/SNS-SQS/_settings/boards-external-integration
# Write a comment to your GitHub entity i.e. issue or a pull request (PR).
- task: GitHubComment@0
  inputs:
    gitHubConnection: github-rob-personal # string. Required. GitHub connection (OAuth or PAT). 
    repositoryName: '$(Build.Repository.Name)' # string. Required. Repository. Default: $(Build.Repository.Name).
    #id: # string. ID of the github pr/issue. 
    comment: "Refer to output.log" # string. Comment.

